name: Production Deployment
run-name: prod-${{ github.event.client_payload.operation || inputs.operation }}

on:
  workflow_dispatch:
    inputs:
      tag:
        required: true
        type: string
      environment:
        required: true
        type: choice
        options:
          - prod-west
          - prod-east
      operation:
        required: true
        type: choice
        options:
          - deployment
          - rollback

  repository_dispatch:
    types: [prod-deploy]

jobs:

# =========================================================
# MANUAL – PROD WEST
# =========================================================
  approval-prod-west:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-west' }}
    runs-on: ubuntu-latest
    environment: prod-west
    steps:
      - run: echo "Approved prod-west"

  deploy-prod-west:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-west' }}
    needs: approval-prod-west
    uses: vasunaidu-2/shared-workflows/.github/workflows/shared-deploy.yml@main
    with:
      service: ${{ github.event.repository.name }}
      tag: ${{ inputs.tag }}
      environment: prod-west
      region: us-west-2
      operation: ${{ inputs.operation }}

# =========================================================
# MANUAL – PROD EAST
# =========================================================
  approval-prod-east:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-east' }}
    runs-on: ubuntu-latest
    environment: prod-east
    steps:
      - run: echo "Approved prod-east"

  deploy-prod-east:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-east' }}
    needs: approval-prod-east
    uses: vasunaidu-2/shared-workflows/.github/workflows/shared-deploy.yml@main
    with:
      service: ${{ github.event.repository.name }}
      tag: ${{ inputs.tag }}
      environment: prod-east
      region: us-east-1
      operation: ${{ inputs.operation }}

# =========================================================
# ORCHESTRATOR – PROD WEST
# =========================================================
  deploy-auto-prod-west:
    if: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'prod-west' }}
    uses: vasunaidu-2/shared-workflows/.github/workflows/shared-deploy.yml@main
    with:
      service: ${{ github.event.repository.name }}
      tag: ${{ github.event.client_payload.tag }}
      environment: prod-west
      region: us-west-2
      operation: ${{ github.event.client_payload.operation }}

# =========================================================
# ORCHESTRATOR – PROD EAST
# =========================================================
  deploy-auto-prod-east:
    if: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'prod-east' }}
    uses: vasunaidu-2/shared-workflows/.github/workflows/shared-deploy.yml@main
    with:
      service: ${{ github.event.repository.name }}
      tag: ${{ github.event.client_payload.tag }}
      environment: prod-east
      region: us-east-1
      operation: ${{ github.event.client_payload.operation }}

# =========================================================
# DEPLOYMENT SUMMARY
# =========================================================
  deployment-summary:
    runs-on: ubuntu-latest
    needs:
      - deploy-prod-west
      - deploy-prod-east
      - deploy-auto-prod-west
      - deploy-auto-prod-east
    if: >
      github.event_name == 'repository_dispatch' &&
      (github.event.client_payload.environment == 'prod-west' ||
       github.event.client_payload.environment == 'prod-east')
    steps:
      - name: Show Deployment Status
        run: |
          echo "## Deployment Status" >> "$GITHUB_STEP_SUMMARY"
          echo "| Environment | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------------|--------|" >> "$GITHUB_STEP_SUMMARY"

          if [[ "${{ github.event.client_payload.environment }}" == "prod-west" ]]; then
            echo "| prod-west | ✅ Deployed |" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [[ "${{ github.event.client_payload.environment }}" == "prod-east" ]]; then
            echo "| prod-west | ✅ Already Deployed |" >> "$GITHUB_STEP_SUMMARY"
            echo "| prod-east | ✅ Deployed |" >> "$GITHUB_STEP_SUMMARY"
          fi
