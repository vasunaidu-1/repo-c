name: Production Deployment
run-name: prod-${{ github.event.client_payload.operation || inputs.operation }}

on:
  workflow_dispatch:
    inputs:
      tag:
        required: true
        type: string
      environment:
        required: true
        type: choice
        options:
          - prod-west
          - prod-east
      operation:
        required: true
        type: choice
        options:
          - deployment
          - rollback

  repository_dispatch:
    types: [prod-deploy]

jobs:

###########################################################
# ================= MANUAL â€“ PROD WEST ===================
###########################################################

  approval-prod-west:
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-west'
    name: Approval â€“ prod-west
    runs-on: ubuntu-latest
    environment: prod-west
    steps:
      - run: echo "Approved prod-west"

  deploy-prod-west:
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-west'
    name: ${{ inputs.operation == 'rollback' && 'Rollback' || 'Deploy' }} â€“ prod-west
    needs: approval-prod-west
    uses: vasunaidu-2/shared-workflows/.github/workflows/shared-deploy.yml@main
    with:
      service: ${{ github.event.repository.name }}
      tag: ${{ inputs.tag }}
      environment: prod-west
      region: us-west-2
      operation: ${{ inputs.operation }}

###########################################################
# ================= MANUAL â€“ PROD EAST ===================
###########################################################

  approval-prod-east:
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-east'
    name: Approval â€“ prod-east
    runs-on: ubuntu-latest
    environment: prod-east
    steps:
      - run: echo "Approved prod-east"

  deploy-prod-east:
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-east'
    name: ${{ inputs.operation == 'rollback' && 'Rollback' || 'Deploy' }} â€“ prod-east
    needs: approval-prod-east
    uses: vasunaidu-2/shared-workflows/.github/workflows/shared-deploy.yml@main
    with:
      service: ${{ github.event.repository.name }}
      tag: ${{ inputs.tag }}
      environment: prod-east
      region: us-east-1
      operation: ${{ inputs.operation }}

###########################################################
# ============= ORCHESTRATOR â€“ PROD WEST =================
###########################################################

  deploy-auto-prod-west:
    if: github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'prod-west'
    name: ${{ github.event.client_payload.operation == 'rollback' && 'Rollback' || 'Deploy' }} â€“ prod-west (orchestrated)
    uses: vasunaidu-2/shared-workflows/.github/workflows/shared-deploy.yml@main
    with:
      service: ${{ github.event.repository.name }}
      tag: ${{ github.event.client_payload.tag }}
      environment: prod-west
      region: us-west-2
      operation: ${{ github.event.client_payload.operation }}

###########################################################
# ============= ORCHESTRATOR â€“ PROD EAST =================
###########################################################

  deploy-auto-prod-east:
    if: github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'prod-east'
    name: ${{ github.event.client_payload.operation == 'rollback' && 'Rollback' || 'Deploy' }} â€“ prod-east (orchestrated)
    runs-on: ubuntu-latest
    steps:

      # âœ… ONLY SHOW SUMMARY FOR WEST â†’ EAST
      - name: Show west â†’ east sequence summary
        if: github.event.client_payload.sequence == 'west-followed-by-east'
        run: |
          echo "## ðŸŒ Deployment Sequence: WEST â†’ EAST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… prod-west deployment completed before this prod-east run." >> $GITHUB_STEP_SUMMARY

      # âœ… Call your reusable workflow
      - name: Deploy prod-east
        uses: vasunaidu-2/shared-workflows/.github/workflows/shared-deploy.yml@main
        with:
          service: ${{ github.event.repository.name }}
          tag: ${{ github.event.client_payload.tag }}
          environment: prod-east
          region: us-east-1
          operation: ${{ github.event.client_payload.operation }}
