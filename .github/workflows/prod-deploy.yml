name: Production Deployment

on:
  # =========================
  # MANUAL TRIGGER
  # =========================
  workflow_dispatch:
    inputs:
      tag:
        required: true
        type: string
      environment:
        required: true
        type: choice
        options:
          - prod-west
          - prod-east

  # =========================
  # ORCHESTRATOR TRIGGER
  # =========================
  repository_dispatch:
    types: [prod-deploy]

jobs:
# =========================================================
# MANUAL RUN – PROD WEST (APPROVAL REQUIRED)
# =========================================================
  approval-prod-west:
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-west'
    runs-on: ubuntu-latest
    environment: prod-west
    steps:
      - run: echo "Approved prod-west"

  deploy-prod-west:
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-west'
    needs: approval-prod-west
    uses: vasunaidu-2/shared-workflows/.github/workflows/shared-deploy.yml@main
    with:
      service: ${{ github.event.repository.name }}
      tag: ${{ inputs.tag }}
      environment: prod-west
      region: us-west-2

# =========================================================
# MANUAL RUN – PROD EAST (APPROVAL REQUIRED)
# =========================================================
  approval-prod-east:
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-east'
    runs-on: ubuntu-latest
    environment: prod-east
    steps:
      - run: echo "Approved prod-east"

  deploy-prod-east:
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-east'
    needs: approval-prod-east
    uses: vasunaidu-2/shared-workflows/.github/workflows/shared-deploy.yml@main
    with:
      service: ${{ github.event.repository.name }}
      tag: ${{ inputs.tag }}
      environment: prod-east
      region: us-east-1

# =========================================================
# ORCHESTRATOR RUN – NO APPROVAL (REGION DERIVED)
# =========================================================
  deploy-auto:
    if: github.event_name == 'repository_dispatch'
    uses: vasunaidu-2/shared-workflows/.github/workflows/shared-deploy.yml@main
    with:
      service: ${{ github.event.repository.name }}
      tag: ${{ github.event.client_payload.tag }}
      environment: ${{ github.event.client_payload.environment }}
      region: ${{ github.event.client_payload.environment == 'prod-west' && 'us-west-2' || 'us-east-1' }}
