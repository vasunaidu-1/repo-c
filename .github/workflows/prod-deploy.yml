name: Production Deployment
run-name: prod-${{ github.event.client_payload.operation || inputs.operation }}

on:
  workflow_dispatch:
    inputs:
      tag:
        required: true
        type: string
      environment:
        required: true
        type: choice
        options:
          - prod-west
          - prod-east
      operation:
        required: true
        type: choice
        options:
          - deployment
          - rollback

  repository_dispatch:
    types: [prod-deploy]

jobs:

# =========================================================
# MANUAL – PROD WEST
# =========================================================

  approval-prod-west:
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-west'
    name: Approval – prod-west
    runs-on: ubuntu-latest
    environment: prod-west
    steps:
      - run: echo "Approved prod-west"

  deploy-prod-west:
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-west'
    name: ${{ inputs.operation == 'rollback' && 'Rollback' || 'Deploy' }} – prod-west
    needs: approval-prod-west
    uses: vasunaidu-2/shared-workflows/.github/workflows/shared-deploy.yml@main
    with:
      service: ${{ github.event.repository.name }}
      tag: ${{ inputs.tag }}
      environment: prod-west
      region: us-west-2
      operation: ${{ inputs.operation }}

# =========================================================
# MANUAL – PROD EAST
# =========================================================

  approval-prod-east:
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-east'
    name: Approval – prod-east
    runs-on: ubuntu-latest
    environment: prod-east
    steps:
      - run: echo "Approved prod-east"

  deploy-prod-east:
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'prod-east'
    name: ${{ inputs.operation == 'rollback' && 'Rollback' || 'Deploy' }} – prod-east
    needs: approval-prod-east
    uses: vasunaidu-2/shared-workflows/.github/workflows/shared-deploy.yml@main
    with:
      service: ${{ github.event.repository.name }}
      tag: ${{ inputs.tag }}
      environment: prod-east
      region: us-east-1
      operation: ${{ inputs.operation }}

# =========================================================
# ORCHESTRATOR – PROD WEST (ONLY WHEN WEST)
# =========================================================

  deploy-auto-prod-west:
    if: github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'prod-west'
    name: ${{ github.event.client_payload.operation == 'rollback' && 'Rollback' || 'Deploy' }} – prod-west (orchestrated)
    uses: vasunaidu-2/shared-workflows/.github/workflows/shared-deploy.yml@main
    with:
      service: ${{ github.event.repository.name }}
      tag: ${{ github.event.client_payload.tag }}
      environment: prod-west
      region: us-west-2
      operation: ${{ github.event.client_payload.operation }}

# =========================================================
# VERIFY WEST BEFORE EAST (ONLY WHEN EAST)
# =========================================================

  verify-west-before-east:
    if: github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'prod-east'
    name: Verify – prod-west completed before prod-east
    runs-on: ubuntu-latest
    steps:
      - name: Check previous successful west run
        run: |
          echo "Checking if a previous prod-west run exists..."

          CURRENT_RUN_ID=${{ github.run_id }}

          RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?status=success&per_page=50")

          WEST_RUN=$(echo "$RESPONSE" | jq -r --arg CURRENT "$CURRENT_RUN_ID" '
            .workflow_runs[]
            | select(.id < ($CURRENT | tonumber))
            | select(.name == "Production Deployment")
            | .id
            ' | head -n 1)

          if [ -z "$WEST_RUN" ]; then
            echo "❌ ERROR: No previous successful prod-west run found!"
            exit 1
          fi

          echo "✅ Previous prod-west run found."
          echo "West Run ID: $WEST_RUN"

          echo "## Deployment Sequence Verification" >> $GITHUB_STEP_SUMMARY
          echo "✅ prod-west run completed before prod-east." >> $GITHUB_STEP_SUMMARY
          echo "West Run ID: $WEST_RUN" >> $GITHUB_STEP_SUMMARY

# =========================================================
# ORCHESTRATOR – PROD EAST (AFTER VERIFY)
# =========================================================

  deploy-auto-prod-east:
    if: github.event_name == 'repository_dispatch' && github.event.client_payload.environment == 'prod-east'
    name: ${{ github.event.client_payload.operation == 'rollback' && 'Rollback' || 'Deploy' }} – prod-east (orchestrated)
    needs: verify-west-before-east
    uses: vasunaidu-2/shared-workflows/.github/workflows/shared-deploy.yml@main
    with:
      service: ${{ github.event.repository.name }}
      tag: ${{ github.event.client_payload.tag }}
      environment: prod-east
      region: us-east-1
      operation: ${{ github.event.client_payload.operation }}
